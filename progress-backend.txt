# MiddleChalant - Backend Refactor Progress
# Last Updated: 2024-12-30

================================================================================
PROJECT OVERVIEW
================================================================================

Decentralized USDT Escrow System - Refactoring backend to support bot-driven
workflow as per PRD requirements.

Key Changes from Original Implementation:
- Room creation now uses room codes for joining (not direct join)
- Bot guides users through: Role Selection -> Amount Agreement -> Fee Selection -> Deposit -> Release/Cancel
- Users are "sender" and "receiver" (not "buyer" and "seller")
- Fee can be paid by sender, receiver, or split 50/50
- Backend/bot controls escrow wallet and executes transfers
- Timeouts: 15min pre-funding, 30min funding

================================================================================
FEATURE TODO LIST
================================================================================

[x] Feature 1: Database Schema Updates
    - Add room_code, step, fee_payer, last_activity_at, confirmations, disputes table
    - STATUS: COMPLETED

[x] Feature 2: Room Code System
    - Generate codes on creation, join via code endpoint, simplify room creation
    - STATUS: COMPLETED

[x] Feature 3: Bot State Machine
    - Define phases, message templates, transition logic, action handlers
    - STATUS: COMPLETED

[x] Feature 4: Role Selection Phase
    - Select role, reset roles, confirmation tracking
    - STATUS: COMPLETED

[x] Feature 5: Amount Agreement Phase
    - Propose amount, confirm/reject, dual confirmation
    - STATUS: COMPLETED

[x] Feature 6: Fee Configuration Phase
    - Fee payer selection (sender/receiver/split), calculate amounts
    - STATUS: COMPLETED

[x] Feature 7: Escrow Address & Deposit Detection (Mock)
    - Generate escrow address, mock deposit endpoint for testing
    - STATUS: COMPLETED

[x] Feature 8: Release Flow
    - Double confirm, collect receiver address, execute transfer
    - STATUS: COMPLETED

[x] Feature 9: Cancel/Refund Flow
    - Both confirm, collect sender address, execute refund
    - STATUS: COMPLETED

[x] Feature 10: Timeout System
    - 15min pre-funding, 30min funding timeout, scheduler endpoints
    - STATUS: COMPLETED

[x] Feature 11: Dispute System (Mock)
    - Report endpoint, store proof/explanation, admin routes
    - STATUS: COMPLETED

[x] Feature 12: Transaction History
    - Public completed transactions endpoint with filters/pagination
    - STATUS: COMPLETED

================================================================================
FEATURE 1 DETAILS - COMPLETED
================================================================================

Files Changed:
--------------

1. backend-hono/src/db/schema.ts
   - rooms table: Added roomCode, step, feePayer, escrowAddress, depositTxHash,
     releaseTxHash, creatorId, lastActivityAt
   - participants table: Changed address -> userId, added roleConfirmed,
     amountConfirmed, feeConfirmed, releaseConfirmed, cancelConfirmed, payoutAddress
   - messages table: Changed sender -> senderId, added senderType (user/bot/system),
     added metadata for bot actions
   - NEW disputes table: For report functionality
   - NEW transactions table: For public transaction history
   - Added relations for all tables

2. backend-hono/src/types/index.ts
   - ROOM_STEPS: WAITING_FOR_PEER, ROLE_SELECTION, AMOUNT_AGREEMENT, FEE_SELECTION,
     AWAITING_DEPOSIT, FUNDED, RELEASING, CANCELLING, COMPLETED, CANCELLED, EXPIRED
   - ROOM_STATUSES: OPEN, COMPLETED, CANCELLED, EXPIRED, DISPUTED
   - FEE_PAYERS: sender, receiver, split
   - ROLES: sender, receiver
   - SENDER_TYPES: user, bot, system
   - TIMEOUTS: PRE_FUNDING (15min), FUNDING (30min)
   - Updated request/response types

3. backend-hono/src/config/chains.ts (NEW FILE)
   - Chain configuration with USDT addresses for ETH/BSC mainnet and testnets
   - Helper functions: getChainConfig, isChainSupported, getUsdtAddress
   - USDT formatting utilities

4. backend-hono/src/utils/index.ts
   - Added generateRoomCode() - 6-char alphanumeric code

5. backend-hono/src/services/room.service.ts
   - createRoom(): Requires creatorId, auto-assigns USDT address from chain config
   - joinRoomByCode(): Join via room code
   - Added: getRoomByCode, updateRoomStep, setRoomAmount, setFeePayer, etc.

6. backend-hono/src/services/message.service.ts
   - sendBotMessage(): Send bot messages with metadata
   - sendSystemMessage(): Send system notifications

7. backend-hono/src/repositories/room.repository.ts
   - Added findByCode(), findByCreatorId()
   - Participant repo uses userId instead of address
   - Added updateByRoomAndUser()

8. backend-hono/src/controllers/room.controller.ts
   - create(): Auto-joins creator to room
   - joinByCode(): New endpoint
   - getByCode(): Get room by code

9. backend-hono/src/routes/index.ts
   - POST /rooms - only requires name and chainId
   - POST /rooms/join - join by room code
   - GET /rooms/code/:roomCode - get room by code

Database Migration:
-------------------
- Dropped old tables and pushed new schema using: npm run db:push

================================================================================
ROOM FLOW PHASES (Bot State Machine)
================================================================================

1. WAITING_FOR_PEER
   - Room created, waiting for second user to join via room code

2. ROLE_SELECTION
   - Both users present, bot asks each to select Sender or Receiver
   - Both must confirm, roles must be mutually exclusive
   - Reset option available

3. AMOUNT_AGREEMENT
   - Bot asks for deal amount (USDT)
   - Sender proposes amount
   - Both users must confirm

4. FEE_SELECTION
   - Bot shows 1% fee calculation
   - Options: Sender pays, Receiver pays, Split 50/50
   - Both must confirm

5. AWAITING_DEPOSIT
   - Bot shows escrow address and exact amount to send
   - 30min timeout, then ask continue/cancel

6. FUNDED
   - Deposit detected and confirmed
   - Show Release and Cancel options to sender

7. RELEASING
   - Sender clicked Release, double confirmation required
   - Bot asks receiver for payout wallet address
   - Execute transfer

8. CANCELLING
   - Sender clicked Cancel
   - Receiver must confirm cancellation
   - Bot asks sender for refund wallet address
   - Execute refund

9. COMPLETED / CANCELLED / EXPIRED
   - Final states, room is read-only
   - Transaction recorded to public history

================================================================================
FEATURE 12 DETAILS - COMPLETED
================================================================================

Files Created:
--------------

1. backend-hono/src/repositories/transaction.repository.ts
   - findAll(): Get transactions with filters (chainId, status, date range) and pagination
   - findById(), findByRoomId(), findByChainId(), findBySenderId(), findByReceiverId()
   - create(): Record new transaction
   - count(): Get total count for pagination
   - getStats(): Aggregate stats (total, volume, completed, refunded counts)

2. backend-hono/src/services/transaction.service.ts
   - recordTransaction(): Create transaction record on release/refund
   - getTransactionHistory(): Paginated list with hasMore support
   - getUserTransactions(): Get all transactions for a user (merged sender/receiver)
   - getStats(): Stats with formatted volume
   - formatForPublic(): Safe formatting hiding sensitive data

3. backend-hono/src/controllers/transaction.controller.ts
   - GET /transactions - Public transaction history with filters
   - GET /transactions/stats - Aggregate statistics
   - GET /transactions/my - User's transactions (auth required)
   - GET /transactions/chain/:chainId - Filter by chain
   - GET /transactions/:transactionId - Single transaction
   - GET /rooms/:roomId/transaction - Room's transaction

Files Modified:
---------------

1. backend-hono/src/services/bot.service.ts
   - onPayoutAddressConfirmed(): Records COMPLETED transaction on release
   - onRefundAddressConfirmed(): Records REFUNDED transaction on cancel

2. backend-hono/src/routes/index.ts
   - Added all transaction routes

3. backend-hono/src/repositories/index.ts
   - Export transactionRepository

4. backend-hono/src/services/index.ts
   - Export transactionService

5. backend-hono/src/controllers/index.ts
   - Export transactionController

API Endpoints:
--------------
- GET /transactions                    - Public history (filters: chainId, status, startDate, endDate, limit, offset)
- GET /transactions/stats              - Public stats (totalTransactions, totalVolume, completedCount, refundedCount)
- GET /transactions/my                 - User's transactions (requires auth)
- GET /transactions/chain/:chainId     - By chain
- GET /transactions/:transactionId     - Single transaction
- GET /rooms/:roomId/transaction       - Room's transaction

================================================================================
ALL FEATURES COMPLETED
================================================================================

All 12 features for the backend refactor have been implemented:

1. Database Schema - New tables and columns for bot workflow
2. Room Code System - 6-char codes for joining rooms
3. Bot State Machine - Phase transitions and message templates
4. Role Selection - Sender/Receiver selection with confirmations
5. Amount Agreement - Dual confirmation of deal amount
6. Fee Configuration - Sender/Receiver/Split fee payment
7. Deposit Detection - Mock blockchain service (placeholder for real integration)
8. Release Flow - Double confirm + payout address collection
9. Cancel/Refund Flow - Mutual confirmation + refund address collection
10. Timeout System - Pre-funding and funding timeouts with scheduler
11. Dispute System - File disputes with proof/explanation
12. Transaction History - Public ledger of completed deals

================================================================================
FEATURE 13: BLOCKCHAIN INTEGRATION - COMPLETED
================================================================================

Files Modified:
---------------

1. backend-hono/src/services/blockchain.service.ts
   - Full viem integration for real smart contract interactions
   - Supports both mock mode (no contract) and real mode
   - Functions: createDeal, checkDeposit, executeRelease, executeRefund, cancelDeal
   - Uses BOT_PRIVATE_KEY for signing transactions

2. backend-hono/src/services/bot.service.ts
   - Updated to use new blockchain service API (roomId instead of escrowAddress)
   - Creates deal on contract when fee is confirmed
   - Executes release/refund through smart contract

3. backend-hono/src/config/chains.ts
   - Added masterEscrowAddress per chain (from env vars)
   - Added rpcUrl per chain (with defaults)
   - New helpers: getMasterEscrowAddress(), getRpcUrl()

4. backend-hono/src/contracts/masterEscrow.abi.json (NEW)
   - Contract ABI exported from smart contract compilation

5. backend-hono/.env.example
   - Added BOT_PRIVATE_KEY
   - Added MASTER_ESCROW_SEPOLIA, MASTER_ESCROW_BSC_TESTNET, etc.
   - Added RPC URL configurations

Environment Variables for Real Blockchain:
------------------------------------------
BOT_PRIVATE_KEY=<bot_wallet_private_key>
MASTER_ESCROW_SEPOLIA=0x73ADEB9a3BDC45BEC3ca552D529FFEfee06Ed0E1
SEPOLIA_RPC_URL=https://rpc.sepolia.org

================================================================================
ALL BACKEND FEATURES COMPLETED
================================================================================

Completed Features:
1. Database Schema Updates
2. Room Code System
3. Bot State Machine
4. Role Selection Phase
5. Amount Agreement Phase
6. Fee Configuration Phase
7. Escrow Address & Deposit Detection
8. Release Flow
9. Cancel/Refund Flow
10. Timeout System
11. Dispute System
12. Transaction History
13. Blockchain Integration (viem + MasterEscrow contract)

Next Steps for Production:
--------------------------
1. Set up cron jobs for timeout scheduler
2. Add admin authentication for admin routes
3. Add rate limiting for public endpoints
4. Consider WebSocket for real-time updates
5. Deploy MasterEscrow to mainnet chains
6. Set up proper key management for bot wallet

================================================================================
